---
description: CORS and large file upload issues fix for AppSamurai Dashboard
---

# CORS and Large File Upload Fix

## Problem Summary
The AppSamurai Dashboard was experiencing CORS errors and 500 Internal Server Error when uploading large CSV files (8.5MB+ with 57K+ records).

## Error Messages
```
Access to fetch at 'https://appsamurai-dashboard-backend-production-83b0.up.railway.app/api/files' from origin 'https://ubiquitous-sherbet-b4f6bf.netlify.app' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.

POST https://appsamurai-dashboard-backend-production-83b0.up.railway.app/api/files net::ERR_FAILED 500 (Internal Server Error)
```

## Root Causes
1. **CORS Configuration**: Backend CORS settings were not properly configured for preflight requests
2. **Express Body Parser Limit**: 10MB limit was insufficient for large JSON data (CSV → JSON conversion increases size 3-4x)
3. **Memory Issues**: Large JSON data causing memory problems during database insertion

## Solutions Implemented

### 1. Enhanced CORS Configuration
Updated [server/src/index.ts](mdc:server/src/index.ts) with comprehensive CORS settings:

```typescript
app.use(cors({
  origin: function (origin, callback) {
    // Allow requests with no origin (like mobile apps or curl requests)
    if (!origin) return callback(null, true)
    
    // Allow all origins if CORS_ORIGINS is empty
    if (CORS_ORIGINS.length === 0) return callback(null, true)
    
    // Check if origin is in allowed list
    if (CORS_ORIGINS.includes(origin)) {
      return callback(null, true)
    }
    
    // Log blocked origin for debugging
    logger.warn({ origin, allowedOrigins: CORS_ORIGINS }, 'CORS blocked origin')
    return callback(new Error('Not allowed by CORS'))
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'x-api-key', 'X-API-Key'],
  exposedHeaders: ['Content-Length', 'X-Foo'],
  optionsSuccessStatus: 200
}))
```

### 2. CORS Preflight Handler
Added explicit OPTIONS request handler:

```typescript
// Handle preflight OPTIONS requests
app.options('*', (req, res) => {
  res.status(200).end()
})

// API key guard - skip for OPTIONS
app.use((req, res, next) => {
  if (req.path === '/api/health' || req.method === 'OPTIONS') return next()
  const key = req.header('x-api-key')
  if (!API_KEY || key === API_KEY) return next()
  return res.status(401).json({ error: 'Unauthorized' })
})
```

### 3. Extended Express Body Parser Limit
Increased limit from 10MB to 100MB to handle large JSON data:

```typescript
app.use(express.json({ limit: '100mb' }))
```

### 4. Enhanced Error Handling
Added comprehensive validation and error handling:

```typescript
// Validate required fields
if (!name || !size || !uploadDate) {
  return res.status(400).json({ error: 'Missing required fields: name, size, uploadDate' })
}

// Validate data array
if (!Array.isArray(data)) {
  return res.status(400).json({ error: 'Data must be an array' })
}

// Check data size limit (prevent memory issues)
if (data.length > 100000) {
  return res.status(400).json({ error: 'Data too large: maximum 100,000 records allowed' })
}
```

### 5. PostgreSQL Connection Optimization
Increased connection pool and timeout settings:

```typescript
const pool = DATABASE_URL ? new Pool({ 
  connectionString: DATABASE_URL, 
  ssl: DATABASE_URL.includes('proxy.rlwy.net') ? { rejectUnauthorized: false } : undefined,
  max: 50,  // Increased from 20
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 5000  // Increased from 2000
}) : undefined
```

## Environment Variables
Railway environment variables that must be set:
- `CORS_ORIGINS`: `https://ubiquitous-sherbet-b4f6bf.netlify.app`
- `API_KEY`: `public-demo-key`
- `DATABASE_PUBLIC_URL`: PostgreSQL connection string

## Testing Commands
```bash
# Test CORS preflight
curl -X OPTIONS -H "Origin: https://ubiquitous-sherbet-b4f6bf.netlify.app" \
     -H "Access-Control-Request-Method: POST" \
     -H "Access-Control-Request-Headers: content-type,x-api-key" \
     https://appsamurai-dashboard-backend-production-83b0.up.railway.app/api/files

# Test POST request
curl -X POST -H "Content-Type: application/json" \
     -H "Origin: https://ubiquitous-sherbet-b4f6bf.netlify.app" \
     -H "x-api-key: public-demo-key" \
     -d '{"name":"test.csv","size":1000,"uploadDate":"2025-09-10","data":[{"test":"data"}]}' \
     https://appsamurai-dashboard-backend-production-83b0.up.railway.app/api/files

# Test health endpoint
curl -H "x-api-key: public-demo-key" \
     https://appsamurai-dashboard-backend-production-83b0.up.railway.app/api/health
```

## Deployment URLs
- **Frontend**: https://ubiquitous-sherbet-b4f6bf.netlify.app/
- **Backend**: https://appsamurai-dashboard-backend-production-83b0.up.railway.app/
- **GitHub**: https://github.com/BeratGocer/appsamurai-dashboard

## Critical Files Modified
- [server/src/index.ts](mdc:server/src/index.ts) - Main backend server with CORS and file upload logic
- [src/utils/api.ts](mdc:src/utils/api.ts) - Frontend API calls
- [src/components/FileUpload.tsx](mdc:src/components/FileUpload.tsx) - File upload component with fallback logic

## Status
✅ CORS configuration fixed
✅ Preflight OPTIONS handler added
✅ Express body parser limit increased to 100MB
✅ PostgreSQL connection pool optimized
✅ Backend deployed to Railway
✅ Frontend deployed to Netlify
✅ Git changes pushed

## Key Lessons Learned
1. **CSV to JSON Size Increase**: CSV files increase 3-4x in size when converted to JSON
2. **CORS Preflight**: OPTIONS requests must be explicitly handled for POST requests
3. **Express Limits**: Body parser limits must account for JSON conversion overhead
4. **Memory Management**: Large data requires careful memory management in Node.js
5. **Error Logging**: Railway logs are crucial for debugging production issues

## Future Improvements
For handling even larger files (50MB+), consider:
- Streaming upload architecture
- Chunk-based file processing
- Database schema optimization (normalized tables vs JSONB)
- Memory-efficient JSON processing