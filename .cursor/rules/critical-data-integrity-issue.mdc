---
description: Critical data integrity issue - install count data loss persists despite multiple fixes
---

# Critical Data Integrity Issue

## Problem Summary
**70,010 installs from CSV → 45,716 installs in database**
**24,294 installs lost (35% data loss)**

## Root Cause Identified
- **12 rows with 21 columns** instead of expected 20 columns
- **Commas within quoted fields**: `"SFT_34631_5406,undefined"`
- **Entire rows skipped** during CSV parsing
- **24,300 installs lost** from these 12 problematic rows

## Current Status
- ✅ **502 Bad Gateway**: Fixed (DATABASE_URL added)
- ✅ **Header parsing**: Fixed (start loop from li=1)
- ✅ **Column mapping**: Fixed (gönderapp priority)
- ❌ **Database migration**: Still failing (tables don't exist)
- ❌ **21-column rows**: Still not being parsed correctly

## Immediate Action Required
1. **Fix database migration**: Ensure Prisma migrations run on Railway
2. **Fix CSV parser**: Handle quoted fields with commas correctly
3. **Verify 21-column rows**: Ensure they're inserted into database
4. **Test with real CSV**: Verify 70,010 installs are preserved

## Technical Details
### Problematic Rows Pattern
```csv
"Bus Frenzy","AppSa_BusFrenzy_iOS_US_CPE","SFT_34631_5406,undefined","2025-07-01","2025"
```
- **Expected**: 20 columns
- **Actual**: 21 columns (comma splits quoted field)
- **Result**: Row skipped entirely

### Database Schema
```prisma
model CampaignRow {
  id              BigInt  @id @default(autoincrement())
  fileId          String
  app             String
  campaignNetwork String
  adgroupNetwork  String
  day             DateTime
  installs        Int
  // ... other fields
}
```

## Debugging Commands
```bash
# Check 21-column rows in CSV
awk -F',' 'NF==21' 2025-9-5_10_50_adjust_report_export.csv | wc -l

# Test small file first
curl -X POST "https://backend-production-80f6.up.railway.app/files/test-small/ingest" \
  -H "Content-Type: text/csv" --data-binary @test_small.csv

# Test real CSV (only after small file succeeds)
curl -X POST "https://backend-production-80f6.up.railway.app/files/test-real/ingest" \
  -H "Content-Type: text/csv" --data-binary @2025-9-5_10_50_adjust_report_export.csv
```

## Success Criteria
- [ ] Small CSV (5 rows) inserts successfully
- [ ] Database migration runs without errors
- [ ] 21-column rows are parsed and inserted
- [ ] Total installs match CSV: 70,010
- [ ] No rows skipped due to parsing errors

## Priority: CRITICAL
This data loss affects business metrics and must be resolved immediately.